<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Note Bloc</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='15' width='60' height='70' rx='8' fill='%23E0F2FE' stroke='%230078D4' stroke-width='5'/%3E%3Cpath d='M35 35h30M35 50h30M35 65h20' stroke='%23005A9E' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display.swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .win-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .sortable-ghost { opacity: 0.4; background: #c0dfff; }
        .sortable-chosen { cursor: grabbing; }
        .form-container-hidden { max-height: 0; overflow: hidden; padding-top: 0; padding-bottom: 0; margin-bottom: 0; opacity: 0; transition: all 0.5s ease-in-out; }
        .form-container-visible { max-height: 500px; opacity: 1; margin-bottom: 2rem; }
        .notes-grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .note-grid-item { height: 120px; position: relative; overflow: hidden; }
        .note-grid-item:hover { transform: scale(1.1); z-index: 10; height: auto; min-height: 120px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .note-grid-item .note-content { display: none; }
        .note-grid-item:hover .note-content { display: block; }
        .notes-list-view { display: flex; flex-direction: column; gap: 0.5rem; }
        .note-list-item { max-height: 50px; overflow: hidden; }
        .note-list-item:hover { max-height: 200px; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full text-center">
            <div class="h-20 w-20 mx-auto mb-4">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="15" width="60" height="70" rx="8" fill="#E0F2FE" class="dark:fill-gray-700" stroke="#0078D4" stroke-width="5"/><path d="M35 35h30M35 50h30M35 65h20" stroke="#005A9E" class="dark:stroke-sky-400" stroke-width="5" stroke-linecap="round"/></svg>
            </div>
            <div id="login-view" class="win-card rounded-xl p-8 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50">
                <h2 class="text-3xl font-bold text-center mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Seu e-mail" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="login-password" placeholder="Sua senha" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Entrar</button>
                </form>
                <div class="my-6 flex items-center"><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span class="flex-shrink mx-4 text-gray-500 dark:text-gray-400">OU</span><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div></div>
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.651-3.358-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,36.218,44,30.561,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    Entrar com Google
                </button>
                <p class="text-center mt-4">Não tem uma conta? <a href="#" id="show-register" class="text-blue-600 dark:text-sky-400 hover:underline">Registre-se</a></p>
            </div>
            <div id="register-view" class="win-card rounded-xl p-8 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 hidden">
                <h2 class="text-3xl font-bold text-center mb-6">Criar Conta</h2>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="Seu e-mail" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="register-password" placeholder="Crie uma senha" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Registrar</button>
                </form>
                <div class="my-6 flex items-center"><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div><span class="flex-shrink mx-4 text-gray-500 dark:text-gray-400">OU</span><div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div></div>
                <button id="google-register-btn" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.651-3.358-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,36.218,44,30.561,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    Registrar com Google
                </button>
                <p class="text-center mt-4">Já tem uma conta? <a href="#" id="show-login" class="text-blue-600 dark:text-sky-400 hover:underline">Faça login</a></p>
            </div>
            <p id="auth-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="h-12 w-12">
                     <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="15" width="60" height="70" rx="8" fill="#E0F2FE" class="dark:fill-gray-700" stroke="#0078D4" stroke-width="5"/><path d="M35 35h30M35 50h30M35 65h20" stroke="#005A9E" class="dark:stroke-sky-400" stroke-width="5" stroke-linecap="round"/></svg>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-700 dark:text-gray-100">Max Note Bloc</h1>
                    <p id="user-email" class="text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                    <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <div id="add-note-container" class="win-card rounded-xl p-6 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 form-container-hidden">
             <h2 class="text-2xl font-semibold mb-4">Adicionar Novo Script</h2>
             <div class="space-y-4">
                <input type="text" id="script-title" placeholder="Título do Script" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                <textarea id="script-content" placeholder="Conteúdo do script..." rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea>
                <div class="flex gap-4">
                    <button id="cancel-add-btn" class="w-full bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-3 px-4 rounded-lg">Cancelar</button>
                    <button id="add-script-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Salvar Script</button>
                </div>
            </div>
        </div>
        
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-600 dark:text-gray-300">Meus Scripts</h2>
            <div class="flex items-center gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                <button id="view-cards-btn" class="p-2 rounded-md" title="Visualização em Cards"><svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z"></path></svg></button>
                <button id="view-grid-btn" class="p-2 rounded-md" title="Visualização em Grade"><svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V4a1 1 0 00-1-1H3zm1 2h4v4H4V5zm6 0h4v4h-4V5zM4 11h4v4H4v-4zm6 0h4v4h-4v-4z"></path></svg></button>
                <button id="view-list-btn" class="p-2 rounded-md" title="Visualização em Lista"><svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button>
            </div>
        </div>
        <div id="scripts-list"></div>
    </div>

    <button id="show-add-form-btn" class="hidden fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition transform hover:scale-110 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
    </button>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-lg w-full shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4">Editar Script</h2>
            <input type="hidden" id="edit-script-id">
            <div class="space-y-4">
                <input type="text" id="edit-script-title" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                <textarea id="edit-script-content" rows="6" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button id="save-edit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10"></div>

    <script>
        // --- CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = '__SUPABASE_URL__';
        const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY__';
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMENTOS DO DOM ---
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleRegisterBtn = document.getElementById('google-register-btn');
        const viewCardsBtn = document.getElementById('view-cards-btn');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const scriptsList = document.getElementById('scripts-list');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email');
        const authError = document.getElementById('auth-error');
        const addScriptBtn = document.getElementById('add-script-btn');
        const toast = document.getElementById('toast');
        const editModal = document.getElementById('edit-modal');
        const editScriptId = document.getElementById('edit-script-id');
        const editScriptTitle = document.getElementById('edit-script-title');
        const editScriptContent = document.getElementById('edit-script-content');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addNoteContainer = document.getElementById('add-note-container');
        const showAddFormBtn = document.getElementById('show-add-form-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        
        let sortableInstance = null;
        let notesCache = [];
        let currentView = 'cards';

        // --- FUNÇÃO DE LOGIN SOCIAL ---
        async function signInWithProvider(provider) {
            const { error } = await _supabase.auth.signInWithOAuth({ provider: provider });
            if (error) {
                console.error('Erro no login social:', error);
                authError.textContent = 'Erro ao tentar login com ' + provider;
            }
        }
        
        // --- LÓGICA DE VISUALIZAÇÃO E TEMA ---
        const applyView = (view) => {
            currentView = view;
            localStorage.setItem('notesView', view);
            [viewCardsBtn, viewGridBtn, viewListBtn].forEach(btn => btn.classList.remove('bg-white', 'dark:bg-gray-500'));
            if (view === 'cards') viewCardsBtn.classList.add('bg-white', 'dark:bg-gray-500');
            if (view === 'grid') viewGridBtn.classList.add('bg-white', 'dark:bg-gray-500');
            if (view === 'list') viewListBtn.classList.add('bg-white', 'dark:bg-gray-500');
            if (view === 'grid') { scriptsList.className = 'notes-grid-view'; } 
            else if (view === 'list') { scriptsList.className = 'notes-list-view'; } 
            else { scriptsList.className = 'grid grid-cols-1 md:grid-cols-2 gap-6'; }
            renderNotes(notesCache);
        };
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        };

        // --- FUNÇÕES PRINCIPAIS ---
        const showToast = (message, isError = false) => {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        };
        const fetchNotes = async () => {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;
            const { data: notes, error } = await _supabase.from('notes').select('*').eq('user_id', user.id).order('position', { ascending: true });
            if (error) { console.error('Erro ao buscar notas:', error); return; }
            notesCache = notes;
            renderNotes(notes);
        };
        const renderNotes = (notes) => {
            scriptsList.innerHTML = '';
            if (notes.length === 0) {
                scriptsList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">Nenhum script salvo ainda.</p>`;
                return;
            }
            notes.forEach(note => {
                const scriptCard = document.createElement('div');
                scriptCard.dataset.id = note.id;
                let cardHTML = '';
                switch (currentView) {
                    case 'grid':
                        scriptCard.className = 'win-card note-grid-item rounded-xl shadow-md bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 cursor-grab p-4 flex flex-col justify-between';
                        cardHTML = `<div><h3 class="font-bold text-lg text-gray-700 dark:text-gray-100 truncate">${note.title}</h3><p class="note-content text-gray-600 dark:text-gray-300 text-sm mt-2 whitespace-pre-wrap">${note.content}</p></div><div class="flex justify-end space-x-2 mt-2"><!-- Botões aqui (podem ser menores) --></div>`;
                        break;
                    case 'list':
                        scriptCard.className = 'win-card note-list-item rounded-lg shadow-sm bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 cursor-grab p-4';
                        cardHTML = `<div class="flex justify-between items-center"><h3 class="font-bold text-gray-700 dark:text-gray-100 truncate">${note.title}</h3><div class="flex items-center space-x-2"><!-- Botões aqui --></div></div><p class="text-gray-600 dark:text-gray-300 text-sm mt-2 whitespace-pre-wrap pt-2 border-t border-gray-200 dark:border-gray-700">${note.content}</p>`;
                        break;
                    default:
                        scriptCard.className = 'win-card rounded-xl p-5 flex flex-col shadow-md bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 cursor-grab';
                        cardHTML = `<h3 class="text-xl font-bold mb-2 text-gray-700 dark:text-gray-100">${note.title}</h3><p class="text-gray-600 dark:text-gray-300 flex-grow mb-4 whitespace-pre-wrap">${note.content}</p><div class="flex justify-end space-x-2 mt-auto pt-4 border-t border-gray-200 dark:border-gray-700"><button class="copy-btn icon-btn bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg" data-content="${note.content}" title="Copiar"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="edit-btn icon-btn bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 p-2 rounded-lg" data-id="${note.id}" data-title="${note.title}" data-content="${note.content}" title="Editar"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L13.196 7.196z"></path></svg></button><button class="delete-btn icon-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg" data-id="${note.id}" title="Deletar"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                        break;
                }
                if (currentView !== 'cards') {
                    const actionButtonsHTML = `<button class="copy-btn icon-btn bg-blue-600/80 hover:bg-blue-700 text-white p-2 rounded-lg" data-content="${note.content}" title="Copiar"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="edit-btn icon-btn bg-gray-300/80 hover:bg-gray-400 dark:bg-gray-600/80 dark:hover:bg-gray-500 p-2 rounded-lg" data-id="${note.id}" data-title="${note.title}" data-content="${note.content}" title="Editar"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L13.196 7.196z"></path></svg></button><button class="delete-btn icon-btn bg-red-600/80 hover:bg-red-700 text-white p-2 rounded-lg" data-id="${note.id}" title="Deletar"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                     cardHTML = cardHTML.replace('<!-- Botões aqui -->', actionButtonsHTML);
                     cardHTML = cardHTML.replace('<!-- Botões aqui (podem ser menores) -->', actionButtonsHTML);
                }
                scriptCard.innerHTML = cardHTML;
                scriptsList.appendChild(scriptCard);
            });
            if (sortableInstance) { sortableInstance.destroy(); }
            sortableInstance = new Sortable(scriptsList, {
                animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                onEnd: async (evt) => {
                    const noteElements = Array.from(scriptsList.children);
                    const updatePromises = noteElements.map((el, index) => _supabase.from('notes').update({ position: index }).eq('id', el.dataset.id));
                    try { await Promise.all(updatePromises); showToast("Ordem salva com sucesso!"); } 
                    catch (error) { console.error("Erro ao salvar nova ordem:", error); showToast("Não foi possível salvar a nova ordem.", true); fetchNotes(); }
                }
            });
        };

        // --- EVENT LISTENERS ---
        const toggleAddForm = (show) => {
            if (show) {
                addNoteContainer.classList.remove('form-container-hidden');
                addNoteContainer.classList.add('form-container-visible');
                showAddFormBtn.style.display = 'none';
            } else {
                addNoteContainer.classList.add('form-container-hidden');
                addNoteContainer.classList.remove('form-container-visible');
                showAddFormBtn.style.display = 'flex';
            }
        };
        showAddFormBtn.addEventListener('click', () => toggleAddForm(true));
        cancelAddBtn.addEventListener('click', () => toggleAddForm(false));
        addScriptBtn.addEventListener('click', async () => {
            const title = document.getElementById('script-title').value;
            const content = document.getElementById('script-content').value;
            const { data: { user } } = await _supabase.auth.getUser();
            if (!title || !content) { return; }
            const newPosition = notesCache.length;
            const { error } = await _supabase.from('notes').insert({ title, content, user_id: user.id, position: newPosition });
            if (error) { showToast('Erro ao salvar a nota.', true); } else {
                showToast('Nota salva com sucesso!');
                document.getElementById('script-title').value = '';
                document.getElementById('script-content').value = '';
                toggleAddForm(false);
                fetchNotes();
            }
        });
        googleLoginBtn.addEventListener('click', () => signInWithProvider('google'));
        googleRegisterBtn.addEventListener('click', () => signInWithProvider('google'));
        themeToggle.addEventListener('click', () => { const isDark = document.documentElement.classList.toggle('dark'); const newTheme = isDark ? 'dark' : 'light'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await _supabase.auth.signInWithPassword({ email, password }); if (error) authError.textContent = error.message; else authError.textContent = ''; });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const { error } = await _supabase.auth.signUp({ email, password }); if (error) { authError.textContent = error.message; } else { authError.textContent = ''; showToast('Conta criada! Verifique seu e-mail para confirmação.'); loginView.classList.remove('hidden'); registerView.classList.add('hidden'); } });
        logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); });
        scriptsList.addEventListener('click', async (e) => { const button = e.target.closest('button'); if (!button) return; const id = button.dataset.id; if (button.classList.contains('copy-btn')) { const content = button.dataset.content; const textarea = document.createElement('textarea'); textarea.value = content; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showToast('Texto copiado!'); } if (button.classList.contains('delete-btn')) { if (confirm('Tem certeza que deseja apagar este script?')) { const { error } = await _supabase.from('notes').delete().eq('id', id); if (error) showToast('Erro ao apagar.', true); else { showToast('Script apagado.'); fetchNotes(); } } } if (button.classList.contains('edit-btn')) { editScriptId.value = id; editScriptTitle.value = button.dataset.title; editScriptContent.value = button.dataset.content; editModal.classList.remove('hidden'); } });
        saveEditBtn.addEventListener('click', async () => { const id = editScriptId.value; const title = editScriptTitle.value; const content = editScriptContent.value; const { error } = await _supabase.from('notes').update({ title, content }).eq('id', id); if (error) showToast('Erro ao atualizar.', true); else { showToast('Script atualizado!'); editModal.classList.add('hidden'); fetchNotes(); } });
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });

        // --- INICIALIZAÇÃO ---
        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailDisplay.textContent = `Logado como: ${session.user.email}`;
                showAddFormBtn.style.display = 'flex';
                fetchNotes();
            } else {
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                userEmailDisplay.textContent = '';
                showAddFormBtn.style.display = 'none';
            }
        });
        const savedView = localStorage.getItem('notesView') || 'cards';
        applyView(savedView);
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

    </script>
</body>
</html>
