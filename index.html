<!DOCTYPE html>
<html lang="pt-BR" class=""> <!-- A classe 'dark' será adicionada aqui -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Note Bloc</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='15' width='60' height='70' rx='8' fill='%23E0F2FE' stroke='%230078D4' stroke-width='5'/%3E%3Cpath d='M35 35h30M35 50h30M35 65h20' stroke='%23005A9E' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Biblioteca para arrastar e soltar -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .win-card {
            transition: background-color 0.3s ease, border-color 0.3s ease;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c0dfff;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
        /* Animação para o formulário aparecer */
        .form-container-hidden {
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            opacity: 0;
            transition: all 0.5s ease-in-out;
        }
        .form-container-visible {
            max-height: 500px; /* Altura suficiente para o conteúdo */
            opacity: 1;
            margin-bottom: 2rem; /* mb-8 */
        }
    </style>
    <script>
        // Configuração do Tailwind para modo dark
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Container de Autenticação -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full text-center">
            <div class="h-20 w-20 mx-auto mb-4">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="15" width="60" height="70" rx="8" fill="#E0F2FE" class="dark:fill-gray-700" stroke="#0078D4" stroke-width="5"/><path d="M35 35h30M35 50h30M35 65h20" stroke="#005A9E" class="dark:stroke-sky-400" stroke-width="5" stroke-linecap="round"/></svg>
            </div>
            <div id="login-view" class="win-card rounded-xl p-8 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50">
                <h2 class="text-3xl font-bold text-center mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Seu e-mail" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="login-password" placeholder="Sua senha" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Entrar</button>
                </form>
                <p class="text-center mt-4">Não tem uma conta? <a href="#" id="show-register" class="text-blue-600 dark:text-sky-400 hover:underline">Registre-se</a></p>
            </div>
            <div id="register-view" class="win-card rounded-xl p-8 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 hidden">
                <h2 class="text-3xl font-bold text-center mb-6">Criar Conta</h2>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="Seu e-mail" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="register-password" placeholder="Crie uma senha" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Registrar</button>
                </form>
                <p class="text-center mt-4">Já tem uma conta? <a href="#" id="show-login" class="text-blue-600 dark:text-sky-400 hover:underline">Faça login</a></p>
            </div>
            <p id="auth-error" class="text-red-500 text-center mt-4"></p>
        </div>
    </div>

    <!-- Container Principal do App -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="h-12 w-12">
                     <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="15" width="60" height="70" rx="8" fill="#E0F2FE" class="dark:fill-gray-700" stroke="#0078D4" stroke-width="5"/><path d="M35 35h30M35 50h30M35 65h20" stroke="#005A9E" class="dark:stroke-sky-400" stroke-width="5" stroke-linecap="round"/></svg>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-700 dark:text-gray-100">Max Note Bloc</h1>
                    <p id="user-email" class="text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                    <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <!-- Formulário para Adicionar (Oculto por padrão) -->
        <div id="add-note-container" class="win-card rounded-xl p-6 shadow-lg bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 form-container-hidden">
             <h2 class="text-2xl font-semibold mb-4">Adicionar Novo Script</h2>
             <div class="space-y-4">
                <input type="text" id="script-title" placeholder="Título do Script" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                <textarea id="script-content" placeholder="Conteúdo do script..." rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea>
                <div class="flex gap-4">
                    <button id="cancel-add-btn" class="w-full bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-3 px-4 rounded-lg">Cancelar</button>
                    <button id="add-script-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Salvar Script</button>
                </div>
            </div>
        </div>

        <!-- Botão para mostrar o formulário -->
        <div class="flex justify-center mb-6">
            <button id="show-add-form-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 shadow-lg transition transform hover:scale-110">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
        
        <div>
            <h2 class="text-2xl font-semibold mb-4 text-center text-gray-600 dark:text-gray-300">Meus Scripts</h2>
            <div id="scripts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-lg w-full shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4">Editar Script</h2>
            <input type="hidden" id="edit-script-id">
            <div class="space-y-4">
                <input type="text" id="edit-script-title" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                <textarea id="edit-script-content" rows="6" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button id="save-edit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10"></div>

    <script>
        // --- CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = '__SUPABASE_URL__';
        const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY__';
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMENTOS DO DOM ---
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const scriptsList = document.getElementById('scripts-list');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email');
        const authError = document.getElementById('auth-error');
        const addScriptBtn = document.getElementById('add-script-btn');
        const toast = document.getElementById('toast');
        const editModal = document.getElementById('edit-modal');
        const editScriptId = document.getElementById('edit-script-id');
        const editScriptTitle = document.getElementById('edit-script-title');
        const editScriptContent = document.getElementById('edit-script-content');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addNoteContainer = document.getElementById('add-note-container');
        const showAddFormBtn = document.getElementById('show-add-form-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        
        let sortableInstance = null;
        let notesCache = [];

        // --- LÓGICA DO TEMA (MODO DARK) ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        };

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- FUNÇÕES PRINCIPAIS ---
        const showToast = (message, isError = false) => {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        };
        
        const fetchNotes = async () => {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return;

            const { data: notes, error } = await _supabase
                .from('notes')
                .select('*')
                .eq('user_id', user.id)
                .order('position', { ascending: true });

            if (error) {
                console.error('Erro ao buscar notas:', error);
                return;
            }
            notesCache = notes;
            renderNotes(notes);
        };

        const renderNotes = (notes) => {
            scriptsList.innerHTML = '';
            if (notes.length === 0) {
                scriptsList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-1 md:col-span-2 text-center">Nenhum script salvo ainda.</p>`;
                return;
            }
            notes.forEach(note => {
                const scriptCard = document.createElement('div');
                scriptCard.className = 'win-card rounded-xl p-5 flex flex-col shadow-md bg-white/80 dark:bg-gray-800/80 border border-white/20 dark:border-gray-700/50 cursor-grab';
                scriptCard.dataset.id = note.id;
                scriptCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-2 text-gray-700 dark:text-gray-100">${note.title}</h3>
                    <p class="text-gray-600 dark:text-gray-300 flex-grow mb-4 whitespace-pre-wrap">${note.content}</p>
                    <div class="flex justify-end space-x-2 mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button class="copy-btn icon-btn bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg" data-content="${note.content}" title="Copiar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.625v2.625a2.625 2.625 0 01-2.625 2.625H6.75a2.625 2.625 0 01-2.625-2.625V12a2.625 2.625 0 012.625-2.625h2.25" /></svg></button>
                        <button class="edit-btn icon-btn bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 p-2 rounded-lg" data-id="${note.id}" data-title="${note.title}" data-content="${note.content}" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button>
                        <button class="delete-btn icon-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg" data-id="${note.id}" title="Deletar"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 pointer-events-none"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
                    </div>`;
                scriptsList.appendChild(scriptCard);
            });
            
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(scriptsList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: async (evt) => {
                    const noteElements = Array.from(scriptsList.children);
                    const updatePromises = noteElements.map((el, index) => 
                        _supabase
                            .from('notes')
                            .update({ position: index })
                            .eq('id', el.dataset.id)
                    );
                    try {
                        await Promise.all(updatePromises);
                        showToast("Ordem salva com sucesso!");
                    } catch (error) {
                        console.error("Erro ao salvar nova ordem:", error);
                        showToast("Não foi possível salvar a nova ordem.", true);
                        fetchNotes();
                    }
                }
            });
        };

        // --- EVENT LISTENERS ---
        const toggleAddForm = (show) => {
            if (show) {
                addNoteContainer.classList.remove('form-container-hidden');
                addNoteContainer.classList.add('form-container-visible');
                showAddFormBtn.classList.add('hidden');
            } else {
                addNoteContainer.classList.add('form-container-hidden');
                addNoteContainer.classList.remove('form-container-visible');
                showAddFormBtn.classList.remove('hidden');
            }
        };

        showAddFormBtn.addEventListener('click', () => toggleAddForm(true));
        cancelAddBtn.addEventListener('click', () => toggleAddForm(false));

        addScriptBtn.addEventListener('click', async () => {
            const title = document.getElementById('script-title').value;
            const content = document.getElementById('script-content').value;
            const { data: { user } } = await _supabase.auth.getUser();
            if (!title || !content) { return; }
            const newPosition = notesCache.length;
            const { error } = await _supabase.from('notes').insert({ title, content, user_id: user.id, position: newPosition });
            if (error) { showToast('Erro ao salvar a nota.', true); } else {
                showToast('Nota salva com sucesso!');
                document.getElementById('script-title').value = '';
                document.getElementById('script-content').value = '';
                toggleAddForm(false); // Esconde o formulário após salvar
                fetchNotes();
            }
        });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await _supabase.auth.signInWithPassword({ email, password }); if (error) authError.textContent = error.message; else authError.textContent = ''; });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const { error } = await _supabase.auth.signUp({ email, password }); if (error) { authError.textContent = error.message; } else { authError.textContent = ''; showToast('Conta criada! Verifique seu e-mail para confirmação.'); loginView.classList.remove('hidden'); registerView.classList.add('hidden'); } });
        logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); });
        scriptsList.addEventListener('click', async (e) => { const button = e.target.closest('button'); if (!button) return; const id = button.dataset.id; if (button.classList.contains('copy-btn')) { const content = button.dataset.content; const textarea = document.createElement('textarea'); textarea.value = content; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showToast('Texto copiado!'); } if (button.classList.contains('delete-btn')) { if (confirm('Tem certeza que deseja apagar este script?')) { const { error } = await _supabase.from('notes').delete().eq('id', id); if (error) showToast('Erro ao apagar.', true); else { showToast('Script apagado.'); fetchNotes(); } } } if (button.classList.contains('edit-btn')) { editScriptId.value = id; editScriptTitle.value = button.dataset.title; editScriptContent.value = button.dataset.content; editModal.classList.remove('hidden'); } });
        saveEditBtn.addEventListener('click', async () => { const id = editScriptId.value; const title = editScriptTitle.value; const content = editScriptContent.value; const { error } = await _supabase.from('notes').update({ title, content }).eq('id', id); if (error) showToast('Erro ao atualizar.', true); else { showToast('Script atualizado!'); editModal.classList.add('hidden'); fetchNotes(); } });
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });

        // --- INICIALIZAÇÃO ---
        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailDisplay.textContent = `Logado como: ${session.user.email}`;
                fetchNotes();
            } else {
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                userEmailDisplay.textContent = '';
            }
        });
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

    </script>
</body>
</html>
